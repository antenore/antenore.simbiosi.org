<!-- Cookie Consent Banner -->
<div id="cookie-consent" class="cookie-consent">
    <div class="cookie-content">
        <p>This website uses cookies to ensure you get the best experience. By continuing to browse, you agree to our use of cookies.</p>
        <div class="cookie-buttons">
            <button id="cookie-accept" class="btn-accept">Accept</button>
            <a href="/privacy" class="btn-more">Privacy Policy</a>
        </div>
    </div>
</div>

<script>
    /* Cookie handling functions */
    function createCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + value + expires + "; path=/; SameSite=Lax";
        console.log('Cookie created:', name, value);
    }

    function readCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        console.log('Cookie not found:', name);
        return null;
    }

    /* Function to show the cookie consent banner */
    function showCookieConsent() {
        const cookieConsent = document.getElementById('cookie-consent');
        if (cookieConsent) {
            cookieConsent.style.display = 'block';
            console.log('Cookie consent banner shown');
        } else {
            console.error('Cookie consent element not found');
        }
    }

    /* Function to hide the cookie consent banner */
    function hideCookieConsent() {
        const cookieConsent = document.getElementById('cookie-consent');
        if (cookieConsent) {
            cookieConsent.style.display = 'none';
            console.log('Cookie consent banner hidden');
        } else {
            console.error('Cookie consent element not found');
        }
    }

    /* Load Google Tag Manager with Consent Mode v2 */
    function loadGoogleTagManager() {
        /* Add Google Tag Manager script with consent mode */
        const gtagScript = document.createElement('script');
        gtagScript.async = true;
        gtagScript.src = "https://www.googletagmanager.com/gtag/js?id={{ site.analytics-google }}";
        document.head.appendChild(gtagScript);

        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        /* Initialize consent mode v2 - default all to denied */
        gtag('consent', 'default', {
            'ad_storage': 'denied',
            'analytics_storage': 'denied',
            'functionality_storage': 'denied',
            'personalization_storage': 'denied',
            'security_storage': 'granted' // Always grant security storage
        });

        /* Configure Google Analytics with GA4 property */
        gtag('config', '{{ site.analytics-google }}', {
            'anonymize_ip': true
        });
        
        console.log('Google Tag Manager loaded with consent mode');
    }

    /* Function to update consent based on user choice */
    function updateConsent(granted) {
        if (granted) {
            gtag('consent', 'update', {
                'ad_storage': 'granted',
                'analytics_storage': 'granted',
                'functionality_storage': 'granted',
                'personalization_storage': 'granted'
            });
            console.log('Consent granted for all storage types');
        } else {
            gtag('consent', 'update', {
                'ad_storage': 'denied',
                'analytics_storage': 'denied',
                'functionality_storage': 'denied',
                'personalization_storage': 'denied'
            });
            console.log('Consent denied for all storage types');
        }
    }

    /* Wait for DOM to be fully loaded */
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded');
        const cookieConsent = document.getElementById('cookie-consent');
        console.log('Cookie consent element:', cookieConsent);
        
        /* Load Google Tag Manager with consent mode regardless of consent status */
        loadGoogleTagManager();
        
        /* First check if consent was previously given */
        const consentCookie = readCookie('cookie-consent');
        console.log('Consent cookie value:', consentCookie);
        
        if (consentCookie === 'accepted') {
            hideCookieConsent();
            updateConsent(true); // Update consent if previously granted
        } else {
            /* If no consent yet, show the banner */
            showCookieConsent();
        }

        /* Handle accept button click */
        const acceptButton = document.getElementById('cookie-accept');
        if (acceptButton) {
            console.log('Accept button found, adding click listener');
            acceptButton.addEventListener('click', function() {
                console.log('Accept button clicked');
                createCookie('cookie-consent', 'accepted', 365); /* Cookie valid for 1 year */
                hideCookieConsent();
                updateConsent(true); // Update consent when granted
            });
        } else {
            console.error('Accept button not found');
        }
    });

    /* Debug info */
    console.log('Cookie consent script loaded');
</script>
